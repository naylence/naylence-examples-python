name: Test Examples

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test-simple-examples:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        example:
        #   - echo_agent.py
        #   - function_as_agent.py
        #   - rpc_agent.py
        #   - agent_with_bg_task.py
        #   - a2a_agent.py
        #   - agent_ping_pong.py
          - hello.py
      fail-fast: false

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.12
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    
    - name: Install Poetry
      uses: snok/install-poetry@v1
      with:
        version: latest
        virtualenvs-create: true
        virtualenvs-in-project: true
    
    - name: Load cached venv
      id: cached-poetry-dependencies
      uses: actions/cache@v3
      with:
        path: .venv
        key: venv-${{ runner.os }}-${{ steps.setup-python.outputs.python-version }}-${{ hashFiles('**/poetry.lock') }}
    
    - name: Install dependencies
      if: steps.cached-poetry-dependencies.outputs.cache-hit != 'true'
      run: poetry install --no-interaction --no-root
    
    - name: Install project
      run: poetry install --no-interaction --no-root
    
    - name: Test simple example - ${{ matrix.example }}
      working-directory: examples/simple
      run: |
        poetry run python ${{ matrix.example }}

  test-docker-examples:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        example:
        #   # Delivery examples
        #   - examples/delivery/agent-crash-recovery
        #   - examples/delivery/retry-on-no-ack-received
        #   # Distributed examples (excluding LLM-based ones)
        #   - examples/distributed/biomes
        #   - examples/distributed/cancellable
        #   - examples/distributed/capability-routing
        #   - examples/distributed/hello
        #   - examples/distributed/hello-with-sentinel
        #   - examples/distributed/peers
        #   - examples/distributed/push-notifications
        #   - examples/distributed/rpc
        #   - examples/distributed/status-subscription
        #   # Monitoring examples
        #   - examples/monitoring/open-telemetry
        #   # Persistence examples
        #   - examples/persistence/agent-state
        #   - examples/persistence/storage-provider
          # Security examples
          - examples/security/advanced
        #   - examples/security/gated
        #   - examples/security/http-connector
        #   - examples/security/overlay
        #   - examples/security/stickiness
      fail-fast: false

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.12
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    
    - name: Install Poetry
      uses: snok/install-poetry@v1
      with:
        version: latest
        virtualenvs-create: true
        virtualenvs-in-project: true
    
    - name: Load cached venv
      id: cached-poetry-dependencies
      uses: actions/cache@v3
      with:
        path: .venv
        key: venv-${{ runner.os }}-${{ steps.setup-python.outputs.python-version }}-${{ hashFiles('**/poetry.lock') }}
    
    - name: Install dependencies
      if: steps.cached-poetry-dependencies.outputs.cache-hit != 'true'
      run: poetry install --no-interaction --no-root
    
    - name: Install project
      run: poetry install --no-interaction --no-root
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Fix directory permissions
      run: |
        # Ensure the examples directory and subdirectories are writable by all users (for Docker containers)
        sudo chown -R $USER:$USER /home/runner/work/
        find examples -type d -exec chmod 755 {} \;
        # Make config and security directories world-writable for Docker containers
        find examples -name "config" -type d -exec chmod 777 {} \; 2>/dev/null || true
        find examples -name ".secrets" -type d -exec chmod 777 {} \; 2>/dev/null || true
        # Pre-create .secrets directories with proper permissions
        find examples -name "security" -type d -exec mkdir -p {}/.secrets \; 2>/dev/null || true
        find examples -name "security" -type d -exec chmod 777 {}/.secrets \; 2>/dev/null || true
        # Pre-create certs directories for PKI generation
        find examples -name "config" -type d -exec mkdir -p {}/certs \; 2>/dev/null || true
        find examples -name "config" -type d -exec chmod 777 {}/certs \; 2>/dev/null || true
        find examples -name "config" -type d -exec mkdir -p {}/caddy/data \; 2>/dev/null || true
        find examples -name "config" -type d -exec chmod 777 {}/caddy \; 2>/dev/null || true
        find examples -name "config" -type d -exec chmod 777 {}/caddy/data \; 2>/dev/null || true
        # Make caddy data directory recursively accessible so containers can read Caddy's CA
        find examples -name "caddy" -type d -exec chmod -R 755 {} \; 2>/dev/null || true
        # Make the entire examples directory tree writable for Docker bind mounts
        chmod -R a+w examples/ || true
    
    - name: Debug certificate setup
      run: |
        # Debug: Show what certificates are actually generated
        echo "=== Certificate directories after generation ==="
        find examples -name "certs" -type d -exec ls -la {} \; || true
        find examples -name "caddy" -type d -exec find {} -name "*.crt" -exec ls -la {} \; \; || true
        
        # Don't change SSL_CERT_FILE - if it works locally, the config should be correct
        # Just show what's in the env files for debugging
        echo "=== Environment files content ==="
        find examples -name "config/.env.*" -type f -exec echo "=== {} ===" \; -exec head -10 {} \; 2>/dev/null || true
    
    - name: Test docker example - ${{ matrix.example }}
      working-directory: ${{ matrix.example }}
      run: |
        echo "Testing example: ${{ matrix.example }}"
        # Set up environment to use poetry's virtual environment
        export PATH="$(cd ../.. && poetry env info --path)/bin:$PATH"
        
        # Run with verbose output and capture logs on failure
        set -e
        echo "Starting containers..."
        make
        sleep 1
        make run
        # if ! make; then
        #   echo "❌ Container startup failed. Showing logs:"
        #   docker compose logs --tail=100 || true
        #   echo "=== Container states ==="
        #   docker compose ps -a || true
        #   echo "=== Host certificate files ==="
        #   ls -la config/certs/ || echo "No certs directory"
        #   echo "=== Fix Caddy data permissions and retry ==="
        #   # Caddy creates files with restrictive permissions, fix them so containers can access
        #   sudo chmod -R 755 config/caddy/data/ 2>/dev/null || true
        #   echo "=== Caddy CA certificate after permission fix ==="
        #   ls -la config/caddy/data/caddy/pki/authorities/local/ || echo "No Caddy CA directory"
        #   cat config/caddy/data/caddy/pki/authorities/local/root.crt | head -5 || echo "No Caddy root.crt"
        #   echo "=== Generated .env files content ==="
        #   grep -H SSL_CERT_FILE config/.env.* || echo "No SSL_CERT_FILE found"
          
        #   else
        #   # Docker examples
        #   echo "Running docker example in: ${{ matrix.example }}"
        #   cd ${{ matrix.example }}
        #   make init && docker compose up && make run && make clean
        # fi
      timeout-minutes: 10